<!doctype html><html class="theme-next use-motion theme-next-mist"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="stylesheet" type="text/css" href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5"><link rel="stylesheet" type="text/css" href="/css/main.css?v=0.4.5.1"><meta name="keywords" content="Hexo,next"><link rel="alternate" href="/atom.xml" title="Redanula's Blog" type="application/atom+xml"><link rel="shorticon icon" type="image/x-icon" href="/favicon.ico?v=0.4.5.1"><meta property="og:type" content="website"><meta property="og:title" content="Redanula&#39;s Blog"><meta property="og:url" content="http://yoursite.com/index.html"><meta property="og:site_name" content="Redanula&#39;s Blog"><meta property="og:locale" content="zh-Hans"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Redanula&#39;s Blog"><script type="text/javascript" id="hexo.configuration">var CONFIG={scheme:"Mist",sidebar:"post"}</script><title> Redanula's Blog</title></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><!--[if lte IE 8]><div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'> <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode"><img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820" alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari." style='margin-left:auto;margin-right:auto;display: block;'/></a></div><![endif]--><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?cd0419a7cec497e5e5d0831c0c0d58c9";var c=document.getElementsByTagName("script")[0];c.parentNode.insertBefore(e,c)}()</script><div class="container one-column page-home"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><h1 class="site-meta"><span class="logo-line-before"><i></i></span><a href="/" class="brand" rel="start"><span class="logo"><i class="icon-next-logo"></i></span> <span class="site-title">Redanula's Blog</span></a><span class="logo-line-after"><i></i></span></h1><div class="site-nav-toggle"> <button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div><nav class="site-nav"><ul id="menu" class="menu menu-left"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon icon-next-home"></i><br> 首页</a></li><li class="menu-item menu-item-archives"><a href="/archives" rel="section"><i class="menu-item-icon icon-next-archives"></i><br> 归档</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="menu-item-icon icon-next-tags"></i><br> 标签</a></li><li class="menu-item menu-item-guestbook"><a href="/guestbook" rel="section"><i class="menu-item-icon icon-next-guestbook"></i><br> 留言</a></li></ul><div class="site-search"><form class="site-search-form"> <input type="text" id="st-search-input" class="st-search-input st-default-search-input"></form><script type="text/javascript">!function(t,e,n,s,c,i,o){t.SwiftypeObject=c,t[c]=t[c]||function(){(t[c].q=t[c].q||[]).push(arguments)},i=e.createElement(n),o=e.getElementsByTagName(n)[0],i.async=1,i.src="//s.swiftypecdn.com/install/v2/st.js",o.parentNode.insertBefore(i,o)}(window,document,"script",0,"_st"),_st("install","nxUVom3vECYwEssxwyny","2.0.0")</script></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div id="content" class="content"><section id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><header class="post-header"><h1 class="post-title" itemprop="name headline"> <a class="post-title-link" href="/2018/08/21/hello-world/" itemprop="url">Hello World</a></h1><div class="post-meta"> <span class="post-time">发表于 <time itemprop="dateCreated" datetime="2018-08-21T18:02:08+08:00" content="2018-08-21">2018-08-21</time></span> <span class="post-comments-count">&nbsp; | &nbsp;<a href="/2018/08/21/hello-world/#comments" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/08/21/hello-world/" itemprop="commentsCount"></span></a></span></div></header><div class="post-body"><span itemprop="articleBody"><p>Test: Welcome to <a href="http://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="http://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="http://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p><h2 id="Quick_Start">Quick Start</h2><h3 id="Create_a_new_post">Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure><p>More info: <a href="http://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p><h3 id="Run_server">Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="http://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p><h3 id="Generate_static_files">Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="http://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p><h3 id="Deploy_to_remote_sites">Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="http://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p></span></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><header class="post-header"><h1 class="post-title" itemprop="name headline"> <a class="post-title-link" href="/2018/08/01/http-headers/" itemprop="url">.Net Core 添加 HTTP Headers</a></h1><div class="post-meta"> <span class="post-time">发表于 <time itemprop="dateCreated" datetime="2018-08-01T20:43:12+08:00" content="2018-08-01">2018-08-01</time></span> <span class="post-comments-count">&nbsp; | &nbsp;<a href="/2018/08/01/http-headers/#comments" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/08/01/http-headers/" itemprop="commentsCount"></span></a></span></div></header><div class="post-body"><span itemprop="articleBody"><h3 id="前言">前言</h3><p>基于安全的需求，要在API（基于.Net Core）交互的过程中除了特有的鉴权外，还添加额外的Header。</p><h3 id="Strict-Transport-Security">Strict-Transport-Security</h3><h4 id="1-概述">1.概述</h4><p><u>HTTP Strict Transport Security is an excellent feature to support on your site and strengthens your implementation of TLS by getting the User Agent to enforce the use of HTTPS. Recommended value strict-transport-security: max-age=31536000; includeSubDomains.</u></p><p>HTTP Strict Transport Security（HTTP严格安全传输） 通常简称为HSTS，要求浏览器只能通过HTTPS访问当前资源，而不是HTTP。浏览器会自动把所有尝试使用HTTP的请求自动替换为HTTPS请求，在一定范围内（如钓鱼网站等）防止中间人攻击。</p><h4 id="2-示例">2.示例</h4><pre><code><span class="attribute">Strict-Transport-Security</span>: <span class="string">max-age=31536000</span>

<span class="scss"><span class="comment">//includeSubDomains适用于该网站的所有子域名</span>
<span class="value">Strict</span>-Transport-Security<span class="value">: max-age=<span class="number">31536000</span>;</span> includeSubDomains

<span class="comment">//Google维护 首次浏览器加载后可以预加载到缓存，需要向Google申请</span>
<span class="value">Strict</span>-Transport-Security<span class="value">: max-age=<span class="number">31536000</span>;</span> preload</span>
</code></pre><h3 id="Public-Key-Pins">Public-Key-Pins</h3><h4 id="1-概述-1">1.概述</h4><p><u>HTTP Public Key Pinning protects your site from MiTM attacks using rogue X.509 certificates. By whitelisting only the identities that the browser should trust, your users are protected in the event a certificate authority is compromised.</u></p><p>HTTP公钥固定（又称HTTP公钥钉扎，英语：HTTP Public Key Pinning，缩写HPKP）是HTTPS网站防止攻击者利用数字证书认证机构（CA）错误签发的证书进行中间人攻击的一种安全机制，用于预防CA遭受入侵或其他会造成CA签发未授权证书的情况。</p><h4 id="2-示例-1">2.示例</h4><pre><code>/*
<span class="code">    pin-sha256 即证书指纹，允许出现多次（实际上最少应该指定两个）；</span>
<span class="code">    max-age 和 includeSubdomains (可选) 与HSTS一致；</span>
<span class="code">    report-uri(可选) 用来指定验证失败时的上报地址，格式和含义跟 CSP（Content Security Policy）中的同名字段一致；</span>
*/

Public-Key-Pins: pin-sha256="base64=="; max-age=expireTime [<span class="link_label">; includeSubdomains</span>][<span class="link_reference">; report-uri="reportURI"</span>]
</code></pre><h3 id="X-Frame-Options">X-Frame-Options</h3><h4 id="1-概述-2">1.概述</h4><p><u>X-Frame-Options tells the browser whether you want to allow your site to be framed or not. By preventing a browser from framing your site you can defend against attacks like clickjacking. Recommended value x-frame-options: SAMEORIGIN.</u></p><p>X-Frame-Options是用来给浏览器指示允许一个页面可否在 frame,iframe 或者 object 标签中展现的标记。避免了点击劫持 (clickjacking) 的攻击。</p><h4 id="2-示例-2">2.示例</h4><p>在IIS中配置如下：</p><pre><code><span class="tag">&lt;<span class="title">system.webServer</span>&gt;</span>
  ...

  <span class="tag">&lt;<span class="title">httpProtocol</span>&gt;</span>
    <span class="tag">&lt;<span class="title">customHeaders</span>&gt;</span>
      <span class="tag">&lt;<span class="title">add</span> <span class="attribute">name</span>=<span class="value">"X-Frame-Options"</span> <span class="attribute">value</span>=<span class="value">"SAMEORIGIN"</span> /&gt;</span>
    <span class="tag">&lt;/<span class="title">customHeaders</span>&gt;</span>
  <span class="tag">&lt;/<span class="title">httpProtocol</span>&gt;</span>

  ...
<span class="tag">&lt;/<span class="title">system.webServer</span>&gt;</span>
</code></pre><h3 id="X-Content-Type-Options">X-Content-Type-Options</h3><h4 id="1-概述-3">1.概述</h4><p><u>X-Content-Type-Options stops a browser from trying to MIME-sniff the content type and forces it to stick with the declared content-type. The only valid value for this header is X-Content-Type-Options: nosniff</u></p><p>通常浏览器会根据Content-Type字段来区分类型，X-Content-Type-Options用来禁用浏览器的 MIME 类型嗅探。</p><h4 id="2-示例-3">2.示例</h4><pre><code><span class="attribute">X-Content-Type-Options</span>: <span class="string">nosniff</span>
</code></pre><h3 id="Referrer-Policy">Referrer-Policy</h3><h4 id="1-概述-4">1.概述</h4><p><u>Referrer Policy is a new header that allows a site to control how much information the browser includes with navigations away from a document and should be set by all sites.</u></p><p>HTTP来源地址（referer，或HTTP referer）是HTTP表头的一个字段，用来表示从哪儿链接到目前的网页，采用的格式是URL。换句话说，借着HTTP来源地址，目前的网页可以检查访客从哪里而来，这也常被用来对付伪造的跨网站请求。<a href="https://zh.wikipedia.org/wiki/HTTP參照位址" target="_blank" rel="noopener">Referrer维基百科</a></p><h4 id="2-示例-4">2.示例</h4><pre><code><span class="attribute">Referrer-Policy</span>: <span class="string">no-referrer</span>
<span class="attribute">Referrer-Policy</span>: <span class="string">no-referrer-when-downgrade</span>
<span class="attribute">Referrer-Policy</span>: <span class="string">origin</span>
<span class="attribute">Referrer-Policy</span>: <span class="string">origin-when-cross-origin</span>
<span class="attribute">Referrer-Policy</span>: <span class="string">same-origin</span>
<span class="attribute">Referrer-Policy</span>: <span class="string">strict-origin</span>
<span class="attribute">Referrer-Policy</span>: <span class="string">strict-origin-when-cross-origin</span>
<span class="attribute">Referrer-Policy</span>: <span class="string">unsafe-url</span>
</code></pre><p>同源、跨域等策略详细参考：<a href="https://developer.mozilla.org/zh-CN/docs/Web/Security/Same-origin_policy" target="_blank" rel="noopener">同源策略</a></p><h3 id="Content-Security-Policy">Content-Security-Policy</h3><h4 id="1-概述-5">1.概述</h4><p><u>Content Security Policy is an effective measure to protect your site from XSS attacks. By whitelisting sources of approved content, you can prevent the browser from loading malicious assets.</u></p><p>Content Security Policy，网页安全政策，缩写 CSP。CSP可以添加来源白名单，防止XSS攻击，更进一步可以通过<code>report-uri</code>记录异常行为。</p><h4 id="2-示例-5">2.示例</h4><pre><code>Content-Security-<span class="string">Policy:</span> <span class="keyword">default</span>-src <span class="string">'self'</span>; ...; report-uri /my_amazing_csp_report_parser;
</code></pre><h3 id="X-XSS-Protection">X-XSS-Protection</h3><h4 id="1-概述-6">1.概述</h4><p><u>X-XSS-Protection sets the configuration for the cross-site scripting filter built into most browsers. Recommended value “X-XSS-Protection: 1; mode=block”.</u></p><p>X-XSS-Protection 是浏览器默认开启的，防止XSS的保护机制。可以为不支持 CSP 的旧版浏览器的用户提供保护。</p><h4 id="2-示例-6">2.示例</h4><pre><code><span class="comment">//关闭</span>
X-XSS-Protection: <span class="number">0</span>
<span class="comment">//默认开始，清除页面</span>
X-XSS-Protection: <span class="number">1</span>
<span class="comment">//开启，不加载</span>
X-XSS-Protection: <span class="number">1</span>; mode=block
<span class="comment">//CSP 通过`report-uri`记录异常行为</span>
X-XSS-Protection: <span class="number">1</span>; report=&lt;reporting-uri&gt;
</code></pre><h3 id="-Net_Core的_Header_添加">.Net Core的 Header 添加</h3><p>了解以上Header后，对应就要添加.Net Core的Header了，详细参考：<a href="https://andrewlock.net/adding-default-security-headers-in-asp-net-core/" target="_blank" rel="noopener">How to add default security headers in ASP.NET Core using custom middleware</a><br>构建对应的SecurityHeadersMiddleware，然后在<code>Startup.cs</code>的<code>Configure</code>添加：</p><pre><code>app.<span class="type">UseSecurityHeadersMiddleware</span>(<span class="keyword">new</span> <span class="type">SecurityHeadersBuilder</span><span class="literal">()</span>.<span class="type">AddDefaultSecurePolicy</span><span class="literal">()</span>);
</code></pre><p>也可以参考：<a href="https://damienbod.com/2018/02/08/adding-http-headers-to-improve-security-in-an-asp-net-mvc-core-application/" target="_blank" rel="noopener">ADDING HTTP HEADERS TO IMPROVE SECURITY IN AN ASP.NET MVC CORE APPLICATION</a>，在 NuGet Package 里添加 <code>NWebsec.AspNetCore.Middleware</code><br>然后在<code>Startup.cs</code>的<code>Configure</code>添加：</p><pre><code>app.UseHsts<span class="params">(hsts =&gt; hsts.MaxAge<span class="params">(<span class="number">365</span>)</span>.IncludeSubdomains<span class="params">()</span>)</span>;
app.UseXContentTypeOptions<span class="params">()</span>;
app.UseReferrerPolicy<span class="params">(opts =&gt; opts.NoReferrer<span class="params">()</span>)</span>;
app.UseXXssProtection<span class="params">(options =&gt; options.EnabledWithBlockMode<span class="params">()</span>)</span>;
app.UseXfo<span class="params">(options =&gt; options.Deny<span class="params">()</span>)</span>;
app.UseCsp<span class="params">(opts =&gt; opts
    .BlockAllMixedContent<span class="params">()</span>
    .StyleSources<span class="params">(s =&gt; s.Self<span class="params">()</span>)</span>
    .StyleSources<span class="params">(s =&gt; s.UnsafeInline<span class="params">()</span>)</span>
    .FontSources<span class="params">(s =&gt; s.Self<span class="params">()</span>)</span>
    .FormActions<span class="params">(s =&gt; s.Self<span class="params">()</span>)</span>
    .FrameAncestors<span class="params">(s =&gt; s.Self<span class="params">()</span>)</span>
    .ImageSources<span class="params">(s =&gt; s.Self<span class="params">()</span>)</span>
    .ScriptSources<span class="params">(s =&gt; s.Self<span class="params">()</span>)</span>
)</span>;
</code></pre><p>上述文章还推荐了一个在线扫描Header的网站：<a href="https://securityheaders.com/" target="_blank" rel="noopener">https://securityheaders.com/</a> 可以试试网站的安全评分。</p><p>按上述添加完后的响应的Header，Done：<br> <img src="/images/2018080101.png" alt="2018080101"></p><h3 id="参考">参考</h3><p><a href="https://developer.mozilla.org/zh-CN/docs/Security/HTTP_Strict_Transport_Security" target="_blank" rel="noopener">HTTP Strict Transport Security</a><br><a href="https://imququ.com/post/http-public-key-pinning.html" target="_blank" rel="noopener">HTTP Public Key Pinning 介绍</a><br><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/X-Frame-Options" target="_blank" rel="noopener">X-Frame-Options 响应头</a><br><a href="https://docs.microsoft.com/en-us/previous-versions/windows/internet-explorer/ie-developer/compatibility/gg622941(v=vs.85" target="_blank" rel="noopener">Reducing MIME type security risks</a>)<br><a href="http://www.ruanyifeng.com/blog/2016/09/csp.html" target="_blank" rel="noopener">Content Security Policy 入门教程</a><br><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/X-Frame-Options" target="_blank" rel="noopener">X-Frame-Options 响应头</a></p></span></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><header class="post-header"><h1 class="post-title" itemprop="name headline"> <a class="post-title-link" href="/2017/12/20/aspdotnetcoreswagger/" itemprop="url">swagger生成xml文件上传到azure云主机</a></h1><div class="post-meta"> <span class="post-time">发表于 <time itemprop="dateCreated" datetime="2017-12-20T15:25:04+08:00" content="2017-12-20">2017-12-20</time></span> <span class="post-comments-count">&nbsp; | &nbsp;<a href="/2017/12/20/aspdotnetcoreswagger/#comments" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/12/20/aspdotnetcoreswagger/" itemprop="commentsCount"></span></a></span></div></header><div class="post-body"><span itemprop="articleBody"><p>swagger xml文件默认不上传到azure云主机，如需要上传需要修改 <strong>csproj</strong> 文件（Asp.Net Core环境）。添加如下配置：</p><pre><code><span class="tag">&lt;<span class="title">PropertyGroup</span>&gt;</span>
  <span class="tag">&lt;<span class="title">GenerateDocumentationFile</span>&gt;</span>true<span class="tag">&lt;/<span class="title">GenerateDocumentationFile</span>&gt;</span>
<span class="tag">&lt;/<span class="title">PropertyGroup</span>&gt;</span>

<span class="tag">&lt;<span class="title">Target</span> <span class="attribute">Name</span>=<span class="value">"IncludeDocFile"</span> <span class="attribute">BeforeTargets</span>=<span class="value">"PrepareForPublish"</span>&gt;</span>
  <span class="tag">&lt;<span class="title">ItemGroup</span> <span class="attribute">Condition</span>=<span class="value">" '$(DocumentationFile)' != '' "</span>&gt;</span>
    <span class="tag">&lt;<span class="title">_DocumentationFile</span> <span class="attribute">Include</span>=<span class="value">"$(DocumentationFile)"</span> /&gt;</span>
    <span class="tag">&lt;<span class="title">ContentWithTargetPath</span> <span class="attribute">Include</span>=<span class="value">"@(_DocumentationFile-&gt;'%(FullPath)')"</span>
                           <span class="attribute">RelativePath</span>=<span class="value">"%(_DocumentationFile.Identity)"</span>
                           <span class="attribute">TargetPath</span>=<span class="value">"%(_DocumentationFile.Filename)%(_DocumentationFile.Extension)"</span>
                           <span class="attribute">CopyToPublishDirectory</span>=<span class="value">"PreserveNewest"</span> /&gt;</span>
  <span class="tag">&lt;/<span class="title">ItemGroup</span>&gt;</span>
<span class="tag">&lt;/<span class="title">Target</span>&gt;</span>
</code></pre><p><a href="https://github.com/dotnet/sdk/issues/795" target="_blank" rel="noopener">issue: dotnet/sdk/issues/795</a></p></span></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><header class="post-header"><h1 class="post-title" itemprop="name headline"> <a class="post-title-link" href="/2017/08/01/SQL-数据导入/" itemprop="url">SQL--数据导入</a></h1><div class="post-meta"> <span class="post-time">发表于 <time itemprop="dateCreated" datetime="2017-08-01T14:34:56+08:00" content="2017-08-01">2017-08-01</time></span> <span class="post-comments-count">&nbsp; | &nbsp;<a href="/2017/08/01/SQL-数据导入/#comments" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/08/01/SQL-数据导入/" itemprop="commentsCount"></span></a></span></div></header><div class="post-body"><span itemprop="articleBody"><p>之前写API及处理后台数据的时候写了一些脚本，记录一下。</p><p>快捷数据表操作的存储过程脚本。eg: exec ‘Z_InitData’,’目标表T1’,’源表T2’</p><pre><code><span class="operator"><span class="keyword">Create</span> <span class="keyword">PROCEDURE</span> Z_InitData
    @tbname <span class="keyword">nvarchar</span>(<span class="number">100</span>),
    @fromtbname <span class="keyword">nvarchar</span>(<span class="number">100</span>)
<span class="keyword">AS</span>
<span class="keyword">BEGIN</span>
    <span class="comment">-- SET NOCOUNT ON added to prevent extra result sets from</span>
    <span class="comment">-- interfering with SELECT statements.</span>
    <span class="keyword">SET</span> NOCOUNT <span class="keyword">ON</span>;</span>
    <span class="operator"><span class="keyword">declare</span> @<span class="keyword">sql</span> <span class="keyword">nvarchar</span>(<span class="keyword">max</span>)
    <span class="keyword">declare</span> @<span class="keyword">col</span> <span class="keyword">nvarchar</span>(<span class="keyword">max</span>)
    <span class="keyword">set</span> @<span class="keyword">sql</span> = <span class="string">'select @col = stuff((select '',''+name from syscolumns where id=object_id( '''</span>+ @tbname +<span class="string">''') order by name for xml path('''')),1,1,'''')'</span>  
    exec sp_executesql @<span class="keyword">sql</span>,<span class="keyword">N</span><span class="string">'@col nvarchar(max) output'</span>,@<span class="keyword">col</span> <span class="keyword">output</span>
    <span class="keyword">set</span> @<span class="keyword">sql</span> = <span class="string">' truncate table '</span>+ @tbname +<span class="string">';'</span>
    <span class="keyword">set</span> @<span class="keyword">sql</span> = @<span class="keyword">sql</span> + <span class="string">' set IDENTITY_INSERT '</span>+ @tbname +<span class="string">' on ;'</span>
    <span class="keyword">set</span> @<span class="keyword">sql</span> = @<span class="keyword">sql</span> + <span class="string">' insert into '</span>+ @tbname + <span class="string">'('</span>+ @<span class="keyword">col</span> +<span class="string">') select '</span>+@<span class="keyword">col</span>+ <span class="string">' from '</span> + @fromtbname
    <span class="keyword">set</span> @<span class="keyword">sql</span> = @<span class="keyword">sql</span> + <span class="string">'; set IDENTITY_INSERT '</span>+ @tbname +<span class="string">' off;'</span>
    print(@<span class="keyword">sql</span>)
    exec(@<span class="keyword">sql</span>)
<span class="keyword">END</span></span>
</code></pre><hr><p>打印表字段，方便insert。eg: exec ‘Z_Print’,’目标表T1’</p><pre><code><span class="operator"><span class="keyword">ALTER</span> <span class="keyword">PROCEDURE</span> Z_Print
    @tbname <span class="keyword">nvarchar</span>(<span class="number">100</span>) =<span class="string">'TTT'</span>
<span class="keyword">AS</span>
<span class="keyword">BEGIN</span>
    <span class="comment">-- SET NOCOUNT ON added to prevent extra result sets from</span>
    <span class="comment">-- interfering with SELECT statements.</span>
    <span class="keyword">SET</span> NOCOUNT <span class="keyword">ON</span>;</span>
    <span class="operator"><span class="keyword">declare</span> @<span class="keyword">sql</span> <span class="keyword">nvarchar</span>(<span class="keyword">max</span>)
    <span class="keyword">declare</span> @<span class="keyword">col</span> <span class="keyword">nvarchar</span>(<span class="keyword">max</span>)
    <span class="keyword">set</span> @<span class="keyword">sql</span> = <span class="string">'select @col = stuff((select '',''+name from syscolumns where id=object_id( '''</span>+ @tbname +<span class="string">''') order by name for xml path('''')),1,1,'''')'</span>  
    exec sp_executesql @<span class="keyword">sql</span>,<span class="keyword">N</span><span class="string">'@col nvarchar(max) output'</span>,@<span class="keyword">col</span> <span class="keyword">output</span>
    <span class="keyword">set</span> @<span class="keyword">sql</span> = <span class="string">' insert into '</span>+ @tbname + <span class="string">'('</span>+ @<span class="keyword">col</span> +<span class="string">') '</span>
    print(@<span class="keyword">sql</span>)
<span class="keyword">END</span></span>
</code></pre></span></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><header class="post-header"><h1 class="post-title" itemprop="name headline"> <a class="post-title-link" href="/2017/07/31/iOS-Article-001/" itemprop="url">iOS本地时间与同步</a></h1><div class="post-meta"> <span class="post-time">发表于 <time itemprop="dateCreated" datetime="2017-07-31T21:52:35+08:00" content="2017-07-31">2017-07-31</time></span> <span class="post-comments-count">&nbsp; | &nbsp;<a href="/2017/07/31/iOS-Article-001/#comments" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/07/31/iOS-Article-001/" itemprop="commentsCount"></span></a></span></div></header><div class="post-body"><span itemprop="articleBody"><h3 id="概念">概念</h3><p>GMT（Greenwich Mean Time）格林尼治时间<br>UTC（Coordinated Universal Time ）原子钟标准时间<br>Unix time（以UTC 1970年1月1号 00：00：00为基准时间）</p><hr><h3 id="sysctl_API">sysctl API</h3><p>iOS系统上次设备重启时间（iOS9后不能使用）</p><pre><code><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;sys/sysctl.h&gt;</span></span>

- (<span class="keyword">long</span>)bootTime
{
    <span class="preprocessor">#<span class="keyword">define</span> MIB_SIZE <span class="number">2</span></span>
    <span class="keyword">int</span> mib[MIB_SIZE];
    <span class="keyword">size_t</span> size;
    <span class="keyword">struct</span> timeval  boottime;

    mib[<span class="number">0</span>] = CTL_KERN;
    mib[<span class="number">1</span>] = KERN_BOOTTIME;
    size = <span class="keyword">sizeof</span>(boottime);
    <span class="keyword">if</span> (sysctl(mib, MIB_SIZE, &amp;boottime, &amp;size, <span class="literal">NULL</span>, <span class="number">0</span>) != -<span class="number">1</span>)
    {
        <span class="keyword">return</span> boottime.tv_sec;
    }
    <span class="keyword">return</span> <span class="number">0</span>;
}
</code></pre><h3 id="时间校准">时间校准</h3><p>1、记录上一次请求的时候获取服务器时间serverTime，与本地时间lastLocalTime</p><p>2、需要计算的时候取出curLocalTime（即NSDate），计算与lastLocalTime的偏移量T</p><p>3、serverTime+T 就是当前的服务器时间</p><h5 id="另外，计算运行时长，计算自上一次重启后的运行时间">另外，计算运行时长，计算自上一次重启后的运行时间</h5><pre><code><span class="comment">//get system uptime since last boot</span>
- (NSTimeInterval)uptime
{
    <span class="keyword">struct</span> timeval boottime;
    <span class="keyword">int</span> mib[<span class="number">2</span>] = {CTL_KERN, KERN_BOOTTIME};
    <span class="keyword">size_t</span> size = <span class="keyword">sizeof</span>(boottime);

    <span class="keyword">struct</span> timeval now;
    <span class="keyword">struct</span> timezone tz;
    gettimeofday(&amp;now, &amp;tz);

    <span class="keyword">double</span> uptime = -<span class="number">1</span>;

    <span class="keyword">if</span> (sysctl(mib, <span class="number">2</span>, &amp;boottime, &amp;size, <span class="literal">NULL</span>, <span class="number">0</span>) != -<span class="number">1</span> &amp;&amp; boottime.tv_sec != <span class="number">0</span>)
    {
        uptime = now.tv_sec - boottime.tv_sec;
        uptime += (<span class="keyword">double</span>)(now.tv_usec - boottime.tv_usec) / <span class="number">1000000.0</span>;
    }
    <span class="keyword">return</span> uptime;
}
</code></pre><p>详细参考 <a href="http://mrpeak.cn/blog/ios-time/" target="_blank" rel="noopener">http://mrpeak.cn/blog/ios-time/</a></p></span></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><header class="post-header"><h1 class="post-title" itemprop="name headline"> <a class="post-title-link" href="/2017/07/30/iOS-Tips-NSDictionary-NSArray-快捷计算函数/" itemprop="url">iOS Tips--NSDictionary和NSArray 快捷计算函数</a></h1><div class="post-meta"> <span class="post-time">发表于 <time itemprop="dateCreated" datetime="2017-07-30T23:15:46+08:00" content="2017-07-30">2017-07-30</time></span> <span class="post-comments-count">&nbsp; | &nbsp;<a href="/2017/07/30/iOS-Tips-NSDictionary-NSArray-快捷计算函数/#comments" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/07/30/iOS-Tips-NSDictionary-NSArray-快捷计算函数/" itemprop="commentsCount"></span></a></span></div></header><div class="post-body"><span itemprop="articleBody"><p>NSArray 有快捷的汇总公式，只要用 @函数.键路径 即可：</p><pre><code><span class="title">NSArray</span> *array = [NSArray arrayWithObjects:@<span class="string">"1.0"</span>,@<span class="string">"2.0"</span>,nil];
<span class="title">CGFloat</span> sum = [[array valueForKeyPath:@<span class="string">"<span class="variable">@sum</span>.floatValue"</span>] floatValue];
<span class="title">CGFloat</span> avg = [[array valueForKeyPath:@<span class="string">"<span class="variable">@avg</span>.floatValue"</span>] floatValue];
<span class="title">CGFloat</span> max =[[array valueForKeyPath:@<span class="string">"<span class="variable">@max</span>.floatValue"</span>] floatValue];
<span class="title">CGFloat</span> min =[[array valueForKeyPath:@<span class="string">"<span class="variable">@min</span>.floatValue"</span>] floatValue];
</code></pre><p>如果汇总值是在NSDictionary里面，同样可以取值进行汇总：</p><pre><code><span class="name">NSArray</span> *<span class="atom">dic</span> = [{@<span class="string">"KeyName1"</span>:@<span class="string">"1.0"</span>,@<span class="string">"KeyName2"</span>:@<span class="string">"abc"</span>},{@<span class="string">"KeyName1"</span>:@<span class="string">"2.0"</span>,@<span class="string">"KeyName2"</span>:@<span class="string">"bcd"</span>}]; 
<span class="name">CGFloat</span> <span class="atom">sum</span> = [[[<span class="atom">dic</span> <span class="atom">valueForKeyPath</span>:@<span class="string">"KeyName1"</span>] <span class="atom">valueForKeyPath</span>:@<span class="string">"@sum.floatValue"</span>] <span class="atom">floatValue</span>];
<span class="name">CGFloat</span> <span class="atom">max</span> = [[[<span class="atom">dic</span> <span class="atom">valueForKeyPath</span>:@<span class="string">"KeyName1"</span>] <span class="atom">valueForKeyPath</span>:@<span class="string">"@max.floatValue"</span>] <span class="atom">floatValue</span>];
</code></pre><p>以上快捷汇总实际是KVC的用法，更多KVC的用法参考<br>1.<a href="http://www.jianshu.com/p/b7dda8d49dc4" target="_blank" rel="noopener">http://www.jianshu.com/p/b7dda8d49dc4</a><br>2.<a href="https://developer.apple.com/library/content/documentation/General/Conceptual/DevPedia-CocoaCore/KeyValueCoding.html" target="_blank" rel="noopener">https://developer.apple.com/library/content/documentation/General/Conceptual/DevPedia-CocoaCore/KeyValueCoding.html</a></p></span></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><header class="post-header"><h1 class="post-title" itemprop="name headline"> <a class="post-title-link" href="/2017/03/21/Python链家爬虫/" itemprop="url">Python链家爬虫</a></h1><div class="post-meta"> <span class="post-time">发表于 <time itemprop="dateCreated" datetime="2017-03-21T10:23:17+08:00" content="2017-03-21">2017-03-21</time></span> <span class="post-comments-count">&nbsp; | &nbsp;<a href="/2017/03/21/Python链家爬虫/#comments" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/03/21/Python链家爬虫/" itemprop="commentsCount"></span></a></span></div></header><div class="post-body"><span itemprop="articleBody"><p>业余时间做了个链家的爬虫，爬取数据写入sqlite，方便浏览和对比。<br>具体参考了冰蓝大牛的博客<a href="http://lanbing510.info/2016/03/15/Lianjia-Spider.html?utm_source=tuicool&amp;utm_medium=referral" target="_blank" rel="noopener">http://lanbing510.info/2016/03/15/Lianjia-Spider.html?utm_source=tuicool&amp;utm_medium=referral</a>, 根据链家最新的web样式做了修改（2017-03）爬在售的二手房的数据。</p><p>链家对短时间内同一个IP的流量有监控，所以如果用多线程去爬，太快可能会被要求输入验证码。试了以下用代理ip池去爬，因为可用的免费代理ip不多也不稳定，就放弃了。后面想数据爬的也不多，就加个延时模拟人为慢慢爬了，另外还有个问题可能是单位时间内Request太快可能解析不到数据，就把延时放在BeautifulSoup解析后面，并加了如果没有数据则重复5次请求的验证过程，才成功抓全数据：</p><pre><code><span class="tag">time</span>.<span class="function"><span class="title">sleep</span><span class="params">(np.random.rand()</span></span>*<span class="number">3</span>+<span class="number">3</span>)
</code></pre><p>这里贴出关键的匹配代码，代码好粗糙，仅供发参考：）</p><pre><code><span class="function"><span class="keyword">def</span> <span class="title">onsell_spider</span><span class="params">(mydb,url_page=<span class="string">u"http://gz.lianjia.com/ershoufang/pg1rs越秀/"</span>,area=<span class="string">u"越秀"</span>)</span>:</span>
    <span class="comment"># time.sleep(np.random.rand()*1)</span>
    <span class="keyword">print</span> url_page
    counts = <span class="number">0</span>
    trytime = <span class="number">0</span>
    <span class="keyword">while</span> counts==<span class="number">0</span> &amp; trytime&lt;=<span class="number">5</span>:
        <span class="keyword">try</span>:
            req = urllib2.Request(url_page,headers=hds[random.randint(<span class="number">0</span>,len(hds)-<span class="number">1</span>)])
            source_code = urllib2.urlopen(req,timeout=<span class="number">10</span>).read()
            plain_text=unicode(source_code)<span class="comment">#,errors='ignore')   </span>
            soup = BeautifulSoup(plain_text, <span class="string">"lxml"</span>)
        <span class="keyword">except</span> (urllib2.HTTPError, urllib2.URLError), e:
            <span class="keyword">print</span> e
            exception_write(<span class="string">'onsell_spider'</span>,url_page)
            <span class="keyword">return</span>
        <span class="keyword">except</span> Exception,e:
            <span class="keyword">print</span> e
            exception_write(<span class="string">'onsell_spider'</span>,url_page)
            <span class="keyword">return</span>
        time.sleep(np.random.rand()*<span class="number">3</span>+<span class="number">3</span>)
        cj_list=soup.findAll(<span class="string">'div'</span>,{<span class="string">'class'</span>:<span class="string">'info clear'</span>})

        <span class="keyword">print</span> len(cj_list)
        counts = len(cj_list)
        trytime = trytime + <span class="number">1</span>
        <span class="keyword">for</span> cj <span class="keyword">in</span> cj_list:
            info_dict={}
            href=cj.find(<span class="string">'a'</span>)
            <span class="keyword">if</span> <span class="keyword">not</span> href:
                <span class="keyword">continue</span>
            info_dict.update({<span class="string">u'链接'</span>:href.attrs[<span class="string">'href'</span>]})
            name=cj.find(<span class="string">'a'</span>).text
            info_dict.update({<span class="string">u'标题'</span>:name})

     <span class="comment">#href TEXT primary key UNIQUE, name TEXT, community TEXT, style TEXT, area TEXT, orientation TEXT,decoration TEXT,haslift TEXT,floor TEXT, year TEXT, bplace TEXT,splace TEXT, unit_price TEXT, total_price TEXT, subway TEXT, other TEXT</span>

            content=unicode(cj.find(<span class="string">'div'</span>,{<span class="string">'class'</span>:<span class="string">'houseInfo'</span>}).renderContents().strip())
            info=re.match(<span class="string">r"&lt;span .*&gt;&lt;/span&gt;&lt;a .*&gt;(.*)&lt;/a&gt;(.*)"</span>, content)

            <span class="comment"># print info</span>
            <span class="keyword">if</span> info:
                info=info.groups()
                info_dict.update({<span class="string">u'小区'</span>:info[<span class="number">0</span>]})

                str = info[<span class="number">1</span>].strip().split(<span class="string">'|'</span>)
                <span class="comment"># print str[1]</span>

                <span class="keyword">try</span>:
                    info_dict.update({<span class="string">u'户型'</span>:str[<span class="number">1</span>].strip()})
                <span class="keyword">except</span> Exception,e:
                    info_dict.update({<span class="string">u'户型'</span>:<span class="string">''</span>})
                <span class="keyword">try</span>:
                    info_dict.update({<span class="string">u'面积'</span>:str[<span class="number">2</span>].strip()})
                <span class="keyword">except</span> Exception,e:
                    info_dict.update({<span class="string">u'面积'</span>:<span class="string">''</span>})
                <span class="keyword">try</span>:
                    info_dict.update({<span class="string">u'朝向'</span>:str[<span class="number">3</span>].strip()})
                <span class="keyword">except</span> Exception,e:
                    info_dict.update({<span class="string">u'朝向'</span>:<span class="string">''</span>})
                <span class="keyword">try</span>:
                    info_dict.update({<span class="string">u'装修'</span>:str[<span class="number">4</span>].strip()})
                <span class="keyword">except</span> Exception,e:
                    info_dict.update({<span class="string">u'装修'</span>:<span class="string">''</span>})
                <span class="keyword">try</span>:
                    info_dict.update({<span class="string">u'有无电梯'</span>:str[<span class="number">5</span>].strip()})
                <span class="keyword">except</span> Exception,e:
                    info_dict.update({<span class="string">u'有无电梯'</span>:<span class="string">''</span>})

            content=unicode(cj.find(<span class="string">'div'</span>,{<span class="string">'class'</span>:<span class="string">'positionInfo'</span>}).renderContents().strip())
            info=re.match(<span class="string">r"&lt;span .*&gt;&lt;/span&gt;(.*)\)(.*)&lt;a .*&gt;(.*)&lt;/a&gt;"</span>, content)
            <span class="keyword">if</span> info:
                info=info.groups()
                <span class="comment"># print info</span>
                info_dict.update({<span class="string">u'楼层'</span>:info[<span class="number">0</span>]})
                info_dict.update({<span class="string">u'建造时间'</span>:info[<span class="number">1</span>]})
                info_dict.update({<span class="string">u'大区域'</span>:area})
                <span class="keyword">try</span>:
                    info_dict.update({<span class="string">u'小区域'</span>:info[<span class="number">2</span>]})
                <span class="keyword">except</span> Exception,e:
                    info_dict.update({<span class="string">u'小区域'</span>:info[<span class="number">2</span>]})


            content=cj.find(<span class="string">'div'</span>,{<span class="string">'class'</span>:<span class="string">'unitPrice'</span>}).find(<span class="string">'span'</span>).text
            <span class="keyword">if</span> content:
                info_dict.update({<span class="string">u'单价'</span>:content})
            content=cj.find(<span class="string">'div'</span>,{<span class="string">'class'</span>:<span class="string">'totalPrice'</span>}).find(<span class="string">'span'</span>).text
            <span class="keyword">if</span> content:
                info_dict.update({<span class="string">u'总价'</span>:content})

            content=cj.find(<span class="string">'span'</span>,{<span class="string">'class'</span>:<span class="string">'subway'</span>})
            <span class="comment"># print content</span>
            <span class="keyword">if</span> content:
                <span class="keyword">try</span>:
                    info_dict.update({<span class="string">u'地铁'</span>:content.text})
                <span class="keyword">except</span> Exception,e:
                    info_dict.update({<span class="string">u'地铁'</span>:<span class="string">''</span>})

            content=cj.find(<span class="string">'div'</span>,{<span class="string">'class'</span>:<span class="string">'followInfo'</span>}).text
            <span class="keyword">if</span>  content:
                info_dict.update({<span class="string">u'其他'</span>:content})

            command=sql_onsell_insert_command(info_dict)
            mydb.execute(command,<span class="number">1</span>)


<span class="function"><span class="keyword">def</span> <span class="title">do_onsell_spider</span><span class="params">(mydb,area=<span class="string">u"越秀"</span>)</span>:</span>

    url=<span class="string">u"http://gz.lianjia.com/ershoufang/pg%drs%s/"</span> % (<span class="number">1</span>,area)

    <span class="keyword">try</span>:
        req = urllib2.Request(url,headers=hds[random.randint(<span class="number">0</span>,len(hds)-<span class="number">1</span>)])
        source_code = urllib2.urlopen(req,timeout=<span class="number">10</span>).read()
        plain_text=unicode(source_code)<span class="comment">#,errors='ignore')   </span>
        soup = BeautifulSoup(plain_text, <span class="string">"lxml"</span>)
    <span class="keyword">except</span> (urllib2.HTTPError, urllib2.URLError), e:
        <span class="keyword">print</span> e
        exception_write(<span class="string">'do_onsell_spider'</span>,area)
        <span class="keyword">return</span>
    <span class="keyword">except</span> Exception,e:
        <span class="keyword">print</span> e
        exception_write(<span class="string">'do_onsell_spider'</span>,area)
        <span class="keyword">return</span>

    time.sleep(np.random.rand()*<span class="number">1</span>+<span class="number">1</span>)
    content=soup.find(<span class="string">'div'</span>,{<span class="string">'class'</span>:<span class="string">'page-box house-lst-page-box'</span>})
    <span class="comment"># print soup</span>

    <span class="keyword">if</span> content:
        d=<span class="string">"d="</span>+content.get(<span class="string">'page-data'</span>)
        exec(d)
        total_pages=d[<span class="string">'totalPage'</span>]

    <span class="keyword">print</span> total_pages

    <span class="keyword">for</span> i <span class="keyword">in</span> range(total_pages):
        time.sleep(np.random.rand()*<span class="number">1</span>)
        url_page=<span class="string">u"http://gz.lianjia.com/ershoufang/pg%drs%s/"</span> % (i+<span class="number">1</span>,area)
        onsell_spider(mydb,url_page,area)
</code></pre><p>对BeautifulSoup的方法还不太熟悉，用的都是简单粗暴的方法，后续再去细看了。</p><p>爬下来的数据：<br> <img src="images/imgdata.png" alt="imgdata"></p></span></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><header class="post-header"><h1 class="post-title" itemprop="name headline"> <a class="post-title-link" href="/2017/03/13/Python高德爬虫/" itemprop="url">Python高德爬虫</a></h1><div class="post-meta"> <span class="post-time">发表于 <time itemprop="dateCreated" datetime="2017-03-13T14:29:59+08:00" content="2017-03-13">2017-03-13</time></span> <span class="post-comments-count">&nbsp; | &nbsp;<a href="/2017/03/13/Python高德爬虫/#comments" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/03/13/Python高德爬虫/" itemprop="commentsCount"></span></a></span></div></header><div class="post-body"><span itemprop="articleBody"><p>前段时间因公司需求，需要爬取高德地图的数据，就学习了下Python，并做了个简易的爬虫GUI。</p><p>因为高德有api，所以爬数据灰常简单。<br>整个流程：输入城市编码-》根据api爬取数据-》导出到Excel<br>使用的库：BeautifulSoup PyQt5 openpyxl urllib2 requests等</p><p>具体思路：</p><h3 id="高德申请api的key，配置好需要爬取的参数：">高德申请api的key，配置好需要爬取的参数：</h3><p>参数城市、POI分类、查询关键词等,如果不hardcode的部分可以从界面传入</p><pre><code>url = <span class="string">r'http://restapi.amap.com/v3/place/text?&amp;citylimit=true&amp;&amp;output=xml&amp;offset=25&amp;page=1&amp;key=[your key]&amp;extensions=base'</span>
wherestr = <span class="string">r'&amp;city=440106&amp;types=050301&amp;keywords=肯德基'</span>
</code></pre><h3 id="关键抓取代码：">关键抓取代码：</h3><pre><code><span class="function"><span class="keyword">def</span> <span class="title">store_spider</span><span class="params">(self, citystr, storetype, wherestr)</span>:</span>
    page_num=<span class="number">1</span>;
    store_list=[]
    try_times=<span class="number">0</span>

    url = <span class="string">r'http://restapi.amap.com/v3/place/text?&amp;citylimit=true&amp;&amp;output=xml&amp;offset=25&amp;page=1&amp;key=[your key]&amp;extensions=base'</span>
    url = url + wherestr
    total_record = <span class="number">1</span>

    <span class="keyword">while</span>(total_record&gt;<span class="number">0</span>):
        url=url.replace(<span class="string">'page='</span>+str(page_num-<span class="number">1</span>),<span class="string">'page='</span>+str(page_num))

        <span class="comment"># time.sleep(np.random.rand()*1)</span>

        <span class="keyword">try</span>:
            req = urllib2.Request(url, headers=hds[page_num%len(hds)])
            source_code = urllib2.urlopen(req).read()
            plain_text=str(source_code)   
        <span class="keyword">except</span> (urllib2.HTTPError, urllib2.URLError), e:
            <span class="keyword">print</span> e
            try_times+=<span class="number">1</span>;
            <span class="keyword">print</span> try_times
            <span class="keyword">if</span> try_times&gt;<span class="number">10</span>:
                date = QDateTime.currentDateTime(); 
                self.bigEditor.setPlainText(<span class="string">"网络连接异常，抓取【"</span>+ citystr + <span class="string">"】"</span>+ storetype +<span class="string">"结束。"</span> + date.toString(<span class="string">" 时间:yyyy/MM/dd HH:mm:ss"</span>) + <span class="string">"\n"</span> + self.bigEditor.toPlainText())
                <span class="keyword">break</span>
            <span class="keyword">else</span>:
                <span class="keyword">continue</span>

        soup = BeautifulSoup(plain_text, <span class="string">"lxml"</span>)
        list_soup = soup.find(<span class="string">'pois'</span>, {<span class="string">'type'</span>: <span class="string">'list'</span>})

        <span class="comment"># try_times+=1;</span>
        <span class="keyword">if</span> list_soup==<span class="keyword">None</span> <span class="keyword">and</span> try_times&lt;<span class="number">10</span>:
            <span class="keyword">continue</span>
        <span class="keyword">elif</span> list_soup==<span class="keyword">None</span> <span class="keyword">or</span> len(list_soup)&lt;=<span class="number">1</span>:
            <span class="keyword">break</span> 

        total_record_str = soup.find(<span class="string">'count'</span>).string.strip()
        total_record = string.atoi(str(total_record_str))

        <span class="keyword">if</span> total_record == <span class="number">0</span> : <span class="keyword">break</span>

        <span class="keyword">for</span> storeinfo <span class="keyword">in</span> list_soup.findAll(<span class="string">'poi'</span>):
            name  = storeinfo.find(<span class="string">'name'</span>).string.strip()
            location  = storeinfo.find(<span class="string">'location'</span>).string.strip()
            location_list = location.split(<span class="string">','</span>)

            <span class="keyword">try</span>:
                location_logtitudes = location_list[<span class="number">0</span>]
            <span class="keyword">except</span>:
                location_logtitudes = <span class="string">'未知'</span>

            <span class="keyword">try</span>:
                location_autitudes = location_list[<span class="number">1</span>]
            <span class="keyword">except</span>:
                location_autitudes = <span class="string">'未知'</span>

            <span class="keyword">try</span>:
                tel  = storeinfo.find(<span class="string">'tel'</span>).string.strip()
            <span class="keyword">except</span>:
                tel  = <span class="string">''</span>

            <span class="keyword">try</span>:
                adname  = storeinfo.find(<span class="string">'adname'</span>).string.strip()
            <span class="keyword">except</span>:
                adname  = <span class="string">''</span>

            <span class="keyword">try</span>:
                address  = storeinfo.find(<span class="string">'address'</span>).string.strip()
            <span class="keyword">except</span>:
                address  = <span class="string">''</span>

            typecode  = storeinfo.find(<span class="string">'typecode'</span>).string.strip()
            pname  = storeinfo.find(<span class="string">'pname'</span>).string.strip()
            cityname  = storeinfo.find(<span class="string">'cityname'</span>).string.strip()
            amaptype  = storeinfo.find(<span class="string">'type'</span>).string.strip()
            amapid  = storeinfo.find(<span class="string">'id'</span>).string.strip()
            store_list.append([name,pname,cityname,adname,address,location_logtitudes,location_autitudes,tel,storetype,amapid,typecode,amaptype])
        try_times=<span class="number">0</span> 

            <span class="comment"># print 'Page %d' % page_num</span>

        <span class="comment">#输出到GUI</span>
        date = QDateTime.currentDateTime(); 
        self.bigEditor.setPlainText(date.toString(<span class="string">"正在抓取【"</span>+ citystr + <span class="string">"】"</span>+ storetype +<span class="string">",页码: "</span> + str(page_num) + <span class="string">"  时间:yyyy/MM/dd HH:mm:ss"</span>) + <span class="string">"\n"</span> + self.bigEditor.toPlainText())
        app.processEvents()
        page_num+=<span class="number">1</span>
    <span class="keyword">return</span> store_list
</code></pre><h3 id="导出到excel：">导出到excel：</h3><pre><code><span class="comment">#保存到excel</span>
<span class="function"><span class="keyword">def</span> <span class="title">save_storelists_excel</span><span class="params">(self, storelists, citystr)</span>:</span>

    wb=Workbook()
    ws=[]

    <span class="comment"># for i in range(len(typelist)):</span>
    ws.append(wb.create_sheet(title=citystr.decode())) 
    <span class="comment"># for i in range(len(typelist)): </span>
    ws[<span class="number">0</span>].append([<span class="string">'序号'</span>,<span class="string">'商店名称'</span>,<span class="string">'省份'</span>,<span class="string">'城市'</span>,<span class="string">'区/县'</span>,<span class="string">'商店地址'</span>,<span class="string">'经度'</span>,<span class="string">'纬度'</span>,<span class="string">'联系电话'</span>,<span class="string">'商店类型'</span>,<span class="string">'高德ID'</span>,<span class="string">'高德类型ID'</span>,<span class="string">'高德类型'</span>])
    count=<span class="number">1</span>
    <span class="keyword">for</span> storelist <span class="keyword">in</span> storelists:
        <span class="keyword">for</span> st <span class="keyword">in</span> storelist:
            ws[<span class="number">0</span>].append([count,st[<span class="number">0</span>],st[<span class="number">1</span>],st[<span class="number">2</span>],st[<span class="number">3</span>],st[<span class="number">4</span>],st[<span class="number">5</span>],st[<span class="number">6</span>],st[<span class="number">7</span>],st[<span class="number">8</span>],st[<span class="number">9</span>],st[<span class="number">10</span>],st[<span class="number">11</span>]])
            count+=<span class="number">1</span>
    <span class="comment"># 保存excel       </span>
    save_path= <span class="string">'storelist'</span>
    save_path+=(<span class="string">'-'</span>+citystr.decode())
    save_path+=<span class="string">'.xlsx'</span>
    wb.remove_sheet(wb[<span class="string">'Sheet'</span>]); 
    <span class="comment"># save_path = os.path.join(os.path.abspath(os.curdir), save_path)</span>

    <span class="keyword">if</span> getattr(sys, <span class="string">'frozen'</span>, <span class="keyword">False</span>):
        application_path = os.path.dirname(sys.executable)
    <span class="keyword">elif</span> __file__:
        application_path = os.path.dirname(__file__)

    save_path = os.path.join(application_path, save_path)

    wb.save(save_path)

    date = QDateTime.currentDateTime(); 
    self.bigEditor.setPlainText(<span class="string">"导出到目录文件:【"</span> + save_path + date.toString(<span class="string">"】 时间:yyyy/MM/dd HH:mm:ss"</span>) + <span class="string">"\n"</span> + self.bigEditor.toPlainText())
    app.processEvents()
</code></pre><p>另外UI使用的是PyQt5，PyQt的UI从运行到打包一堆坑要踩，不过很多问题都可以搜到解决方案。UI部分做了个输入框，输入城市以后可以从本地sqlite查询对应该城市区域的全部编码，然后赋值到wherestr上，开始爬取数据并输出到QTextEdit。</p><p>总的来说，高德地图API对爬虫很友好，企业认证的调用次数上限都很高，只是貌似每次调用最多就只能返回1000条数据，如果说POI分类多，最好分别进行遍历抓取。这个爬虫都是用到很基础的库，后续有时间继续研究~</p><p>效果截图：<br> <img src="/images/imgui.png" alt="imgui"></p></span></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><header class="post-header"><h1 class="post-title" itemprop="name headline"> <a class="post-title-link" href="/2017/03/01/iOS VPN开发/" itemprop="url">iOS VPN开发</a></h1><div class="post-meta"> <span class="post-time">发表于 <time itemprop="dateCreated" datetime="2017-03-01T11:27:43+08:00" content="2017-03-01">2017-03-01</time></span> <span class="post-comments-count">&nbsp; | &nbsp;<a href="/2017/03/01/iOS VPN开发/#comments" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/03/01/iOS VPN开发/" itemprop="commentsCount"></span></a></span></div></header><div class="post-body"><span itemprop="articleBody"><p>#####参考链接：<br>1.iOS 9 Network Extension VPN API编程指南<a href="http://www.helusi.com/ios9-network-extension-vpn-api/" target="_blank" rel="noopener">http://www.helusi.com/ios9-network-extension-vpn-api/</a><br>2.分享开发 iOS 和 Mac 全新 VPN 的艰难历程<a href="https://www.v2ex.com/t/264480" target="_blank" rel="noopener">https://www.v2ex.com/t/264480</a><br>3.Potatso原理解析<a href="https://www.kidneyband.com/?p=174" target="_blank" rel="noopener">https://www.kidneyband.com/?p=174</a></p><p>#####苹果开发者文档：<br>NEPacketTunnelProvider<a href="https://developer.apple.com/reference/networkextension/nepackettunnelprovider?language=objc" target="_blank" rel="noopener">https://developer.apple.com/reference/networkextension/nepackettunnelprovider?language=objc</a><br>SimpleTunnel<a href="https://developer.apple.com/library/prerelease/content/samplecode/SimpleTunnel/Introduction/Intro.html" target="_blank" rel="noopener">https://developer.apple.com/library/prerelease/content/samplecode/SimpleTunnel/Introduction/Intro.html</a></p></span></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><header class="post-header"><h1 class="post-title" itemprop="name headline"> <a class="post-title-link" href="/2015/11/26/UITableView-and-UIActivityIndicatorView/" itemprop="url">UITableView-and-UIActivityIndicatorView 同页面的设置</a></h1><div class="post-meta"> <span class="post-time">发表于 <time itemprop="dateCreated" datetime="2015-11-26T00:01:59+08:00" content="2015-11-26">2015-11-26</time></span> <span class="post-comments-count">&nbsp; | &nbsp;<a href="/2015/11/26/UITableView-and-UIActivityIndicatorView/#comments" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/11/26/UITableView-and-UIActivityIndicatorView/" itemprop="commentsCount"></span></a></span></div></header><div class="post-body"><span itemprop="articleBody"><hr><p>storyboard 中 UIActivityIndicatorView 要放在tabelview下方<br>tableview y设置为0 重设约束才能保证tableview的顶部不会空白。</p></span></div><footer class="post-footer"><div class="post-eof"></div></footer></article></section><nav class="pagination"> <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">&raquo;</a></nav></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><section class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" src="/images/avatar.jpg" alt="Redanula" itemprop="image"><p class="site-author-name" itemprop="name">Redanula</p></div><p class="site-description motion-element" itemprop="description"></p><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives"><span class="site-state-item-count">13</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <span class="site-state-item-count">0</span> <span class="site-state-item-name">分类</span></div><div class="site-state-item site-state-tags"> <a href="/tags"><span class="site-state-item-count">18</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="menu-item-icon icon-next-feed"></i> RSS</a></div><div class="links-of-author motion-element"> <span class="links-of-author-item"><a href="https://github.com/redanula" target="_blank">github</a></span> <span class="links-of-author-item"><a href="http://weibo.com/redanula" target="_blank">weibo</a></span></div><div class="links-of-author motion-element"></div></section></div></aside></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright"> &copy; &nbsp; <span itemprop="copyrightYear">2018</span><span class="with-love"><i class="icon-next-heart"></i></span> <span class="author" itemprop="copyrightHolder">Redanula</span></div><div class="powered-by"> 由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动</div><div class="theme-info"> 主题 - <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a></div></div></footer><div class="back-to-top"></div></div><script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script><script type="text/javascript">var disqus_shortname="redanula",disqus_identifier="index.html",disqus_title="",disqus_url="";function run_disqus_script(s){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/"+s,(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}run_disqus_script("count.js")</script><script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script><script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.1"></script><script type="text/javascript" src="/js/helpers.js?v=0.4.5.1"></script><script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script><script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script><script type="text/javascript" src="/js/motion_global.js?v=0.4.5.1" id="motion.global"></script><script type="text/javascript" src="/js/nav-toggle.js?v=0.4.5.1"></script><script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript">$(document).ready(function(){"always"===CONFIG.sidebar&&displaySidebar(),isMobile()&&FastClick.attach(document.body)})</script><script type="text/javascript" src="/js/lazyload.js"></script><script type="text/javascript">$(function(){$("#posts").find("img").lazyload({placeholder:"/images/loading.gif",effect:"fadeIn"})})</script></body></html>